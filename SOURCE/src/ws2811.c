#include "ws2811.h"

uint8_t WS2811_CH1[LEDS_CH1];
uint8_t WS2811_CH2[LEDS_CH2];
uint8_t WS2811_CH3[LEDS_CH3];

uint8_t WS2811_DMA_CH1[LEDS_CH1][0x08];
uint8_t WS2811_DMA_CH2[LEDS_CH2][0x08];
uint8_t WS2811_DMA_CH3[LEDS_CH3][0x08];

void WS2811_LEDS_Update(void){



}


void WS2811Clear(void){
  uint8_t l, i;
  for(l=0; l < LEDS_CH1; l++){ for(i=0; i<8; i++){ WS2811_DMA_CH1[l][i] = WS2811_LED_LOW;} }
  for(l=0; l < LEDS_CH2; l++){ for(i=0; i<8; i++){ WS2811_DMA_CH1[l][i] = WS2811_LED_LOW;} }
  for(l=0; l < LEDS_CH3; l++){ for(i=0; i<8; i++){ WS2811_DMA_CH1[l][i] = WS2811_LED_LOW;} }
}

void WS2811Reset(void){
  TIM2->CR1 &= ~(TIM_CR1_CEN);
  TIM2->ARR = WS2811_RESET;
  TIM2->CNT = 0;
  TIM2->CCR1 = 0x0000;
  TIM2->CCR2 = 0x0000;
  TIM2->CCR3 = 0x0000;
  TIM2->SR &= ~(TIM_SR_UIF);
  TIM2->DIER |= TIM_DIER_UIE;
  TIM2->CR1 |= TIM_CR1_CEN;
}

void WS2811Init(void){
  GPIOA->CRL &= ~(GPIO_CRL_CNF0 | GPIO_CRL_CNF1 | GPIO_CRL_CNF2);
  GPIOA->CRL |= GPIO_CRL_MODE0 | GPIO_CRL_MODE1 | GPIO_CRL_MODE2;
  GPIOA->CRL |= GPIO_CRL_CNF0_1 | GPIO_CRL_CNF1_1 | GPIO_CRL_CNF2_1;
  
  TIM2->CCER = TIM_CCER_CC1E | TIM_CCER_CC2E | TIM_CCER_CC3E;
  TIM2->CCMR1 |= TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1 | TIM_CCMR1_OC1PE;
  TIM2->CCMR1 |= TIM_CCMR1_OC2M_2 | TIM_CCMR1_OC2M_1 | TIM_CCMR1_OC2PE;
  TIM2->CCMR2 |= TIM_CCMR2_OC3M_2 | TIM_CCMR2_OC3M_1 | TIM_CCMR2_OC3PE;
  TIM2->CR1 = TIM_CR1_ARPE;
  TIM2->DIER = TIM_DIER_CC1DE | TIM_DIER_CC2DE | TIM_DIER_CC3DE;
  
  WS2811Clear();
  
  NVIC_EnableIRQ(TIM2_IRQn);
  NVIC_EnableIRQ(DMA1_Channel1_IRQn);
  NVIC_EnableIRQ(DMA1_Channel5_IRQn);
  NVIC_EnableIRQ(DMA1_Channel7_IRQn);
}


void DMA1_Channel7_IRQHandler(void){
  DMA1_Channel7->CCR &= ~(DMA_CCR7_EN);
  DMA1->IFCR = DMA_IFCR_CTEIF7 | DMA_IFCR_CHTIF7 | DMA_IFCR_CTCIF7 | DMA_IFCR_CGIF7; 
  
}

void DMA1_Channel5_IRQHandler(void){
  DMA1_Channel5->CCR &= ~(DMA_CCR5_EN);
  DMA1->IFCR = DMA_IFCR_CTEIF5 | DMA_IFCR_CHTIF5 | DMA_IFCR_CTCIF5 | DMA_IFCR_CGIF5; 
  
}

void DMA1_Channel1_IRQHandler(void){
  DMA1_Channel1->CCR &= ~(DMA_CCR1_EN);
  DMA1->IFCR = DMA_IFCR_CTEIF1 | DMA_IFCR_CHTIF1 | DMA_IFCR_CTCIF1 | DMA_IFCR_CGIF1; 
  
}

void TIM2_IRQHandler(void){
  TIM2->SR = 0;
  TIM2->CR1 &= ~(TIM_CR1_CEN);
  TIM2->DIER &= ~(TIM_DIER_UIE);
  
  TIM2->ARR = WS2811_LED_FR;
  TIM2->CCR1 = 0x0000;
  TIM2->CCR2 = 0x0000;
  TIM2->CCR3 = 0x0000;
  TIM2->CNT = 0;
  TIM2->CR1 |= TIM_CR1_CEN;
  
  DMA1_Channel5->CPAR = (uint32_t) (&TIM2->CCR1);
  DMA1_Channel5->CMAR = (uint32_t) (&WS2811_DMA_CH1);
  DMA1_Channel5->CNDTR = (LEDS_CH1) * 0x08;
  DMA1_Channel5->CCR |= DMA_CCR5_MINC | DMA_CCR5_DIR | DMA_CCR5_PSIZE_0;
  
  DMA1_Channel7->CPAR = (uint32_t) (&TIM2->CCR2);
  DMA1_Channel7->CMAR = (uint32_t) (&WS2811_DMA_CH2);
  DMA1_Channel7->CNDTR = (LEDS_CH2) * 0x08;
  DMA1_Channel7->CCR |= DMA_CCR7_MINC | DMA_CCR7_DIR | DMA_CCR7_PSIZE_0;
  
  DMA1_Channel1->CPAR = (uint32_t) (&TIM2->CCR3);
  DMA1_Channel1->CMAR = (uint32_t) (&WS2811_DMA_CH3);
  DMA1_Channel1->CNDTR = (LEDS_CH3) * 0x08;
  DMA1_Channel1->CCR |= DMA_CCR3_MINC | DMA_CCR3_DIR | DMA_CCR3_PSIZE_0;
  
  DMA1->IFCR = DMA_IFCR_CTEIF7 | DMA_IFCR_CHTIF7 | DMA_IFCR_CTCIF7 | DMA_IFCR_CGIF7;
  DMA1->IFCR = DMA_IFCR_CTEIF5 | DMA_IFCR_CHTIF5 | DMA_IFCR_CTCIF5 | DMA_IFCR_CGIF5;
  DMA1->IFCR = DMA_IFCR_CTEIF1 | DMA_IFCR_CHTIF1 | DMA_IFCR_CTCIF1 | DMA_IFCR_CGIF1;
  
  DMA1_Channel5->CCR |= DMA_CCR5_TCIE;
  DMA1_Channel7->CCR |= DMA_CCR7_TCIE;
  DMA1_Channel1->CCR |= DMA_CCR1_TCIE;
  
  DMA1_Channel5->CCR |= DMA_CCR5_EN;
  DMA1_Channel7->CCR |= DMA_CCR7_EN;
  DMA1_Channel1->CCR |= DMA_CCR1_EN;
}


